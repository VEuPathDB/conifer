#!/usr/bin/perl
use strict;
my ($projectHomeDir, $branch) = @ARGV;

usage() unless $projectHomeDir && $branch;

die "Error: $projectHomeDir must be a full path\n" unless $projectHomeDir =~ /^\//;

chdir($projectHomeDir) || die "Can't chdir to '$projectHomeDir'\n";

my @dirs = map {chomp; $_} `ls`;

my $url = 'https://www.cbil.upenn.edu/svn';

my @needIt;
foreach my $dir (@dirs) {
  print STDERR ".";
  my $svnName = $dir;
  $svnName = "GusAppFramework" if $dir eq "GUS";

  chdir("$projectHomeDir/$dir") || die "Error: Can't chdir into '$projectHomeDir/$dir'\n";
  my $target = $branch eq 'trunk'? "trunk" : "branches/$branch";
  my $cmd = "svn mergeinfo ^/$svnName/$target --show-revs eligible";
  push(@needIt, $dir) if `$cmd` ne "";
}
print STDERR "\n";
print STDERR "No projects need to be merged\n" unless scalar(@needIt);

print join("\n", @needIt) . "\n";

sub usage {
  print STDERR "
Get a report on which projects in a \$PROJECT_HOME need to be merged into SVN.

Usage: fgpMergeReport project_home_dir trunk|my_branch_name

Where:
  project_home_dir:      full path of the \$PROJECT_HOME you will merge into
  trunk|my_branch_name:  where you will merge from

For a sync merge:
  \% fgpMergeReport branch_project_home trunk

For a reintegration merge:
  \% fgpMergeReport trunk_project_home my_branch_name


";
exit(1);
}
